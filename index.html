<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devinez le mot</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e1f22">

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background: #1e1f22;
  color: #fff;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

header {
  padding: 10px;
  background: #2b2d31;
  text-align: center;
  font-weight: bold;
  font-size: 20px;
}

#game {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
}

#wordDisplay {
  font-size: 28px;
  letter-spacing: 5px;
  margin: 20px 0;
}

#letters {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  justify-content: center;
}

.letterBtn {
  padding: 10px 12px;
  border-radius: 5px;
  border: none;
  background: #5865f2;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

.letterBtn:disabled {
  background: #444;
  cursor: default;
}

#info {
  margin: 10px 0;
}

#inputWord {
  padding: 10px;
  font-size: 18px;
  border-radius: 5px;
  border: none;
  outline: none;
}

#sendWord {
  padding: 10px 15px;
  margin-left: 5px;
  border-radius: 5px;
  border: none;
  background: #00aaff;
  color: black;
  font-weight: bold;
  cursor: pointer;
}
</style>
</head>
<body>

<header>Devinez le mot</header>

<div id="game">
  <div id="setup">
    <input id="inputWord" placeholder="Joueur 1 : Tape le mot..." />
    <button id="sendWord">Lancer Partie</button>
  </div>

  <div id="info"></div>

  <div id="wordDisplay"></div>

  <div id="letters"></div>

  <div id="errors"></div>

  <div id="score"></div>
</div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDL2DDkIFq3HQW8fQLYlGWlVD_KiFb_6iA",
  authDomain: "chat1-591c8.firebaseapp.com",
  projectId: "chat1-591c8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
signInAnonymously(auth);

// ===== Utilisateur / pseudo =====
let pseudo = localStorage.getItem("pseudo");
if (!pseudo) {
  pseudo = prompt("Ton pseudo ?");
  localStorage.setItem("pseudo", pseudo);
}

// ===== Variables =====
let gameId = "pendu1"; // simplifié pour l’instant une seule partie
let maxErrors = 6;

// ===== Référence Firestore =====
const gameRef = doc(db, "games", gameId);

// ===== Setup Joueur 1 =====
const setupDiv = document.getElementById("setup");
const inputWord = document.getElementById("inputWord");
const sendWord = document.getElementById("sendWord");
const wordDisplay = document.getElementById("wordDisplay");
const lettersDiv = document.getElementById("letters");
const infoDiv = document.getElementById("info");
const errorsDiv = document.getElementById("errors");
const scoreDiv = document.getElementById("score");

let currentWord = "";
let guessed = [];
let errors = 0;

// ===== Alphabet =====
const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

// ===== Créer boutons lettres =====
function createLetterButtons() {
  lettersDiv.innerHTML = "";
  alphabet.forEach(l => {
    const btn = document.createElement("button");
    btn.textContent = l;
    btn.className = "letterBtn";
    btn.onclick = () => guessLetter(l);
    btn.disabled = guessed.includes(l);
    lettersDiv.appendChild(btn);
  });
}

// ===== Affichage mot =====
function updateWordDisplay(word, guesses) {
  let display = "";
  for (const c of word) {
    if (c === " ") display += "  ";
    else display += guesses.includes(c.toUpperCase()) ? c.toUpperCase() + " " : "_ ";
  }
  wordDisplay.textContent = display.trim();
}

// ===== Envoi mot =====
sendWord.onclick = async () => {
  const word = inputWord.value.trim().toUpperCase();
  if (!word) return;
  currentWord = word;
  guessed = [];
  errors = 0;

  await setDoc(gameRef, {
    word: currentWord,
    guesses: [],
    errors: 0,
    turn: pseudo,
    winner: "",
    player1: pseudo,
    player2: "",
    createdAt: serverTimestamp()
  });

  setupDiv.style.display = "none";
  infoDiv.textContent = "Partie lancée ! Joueur 2 rejoint...";
  createLetterButtons();
  updateWordDisplay(currentWord, guessed);
};

// ===== Deviner lettre =====
async function guessLetter(letter) {
  const docSnap = await getDoc(gameRef);
  if (!docSnap.exists()) return;
  const data = docSnap.data();

  // joueur 2 si pas encore enregistré
  if (!data.player2 && pseudo !== data.player1) {
    await updateDoc(gameRef, { player2: pseudo });
  }

  // Vérifier si déjà deviné
  if (data.guesses.includes(letter)) return;

  // Mettre à jour Firestore
  const newGuesses = [...data.guesses, letter];
  let newErrors = data.errors;
  if (!data.word.includes(letter)) newErrors++;

  let winner = "";
  // vérifier victoire
  const won = data.word.split("").every(c => c === " " || newGuesses.includes(c));
  if (won) winner = pseudo;
  else if (newErrors >= maxErrors) winner = data.player1 === pseudo ? data.player2 : data.player1;

  await updateDoc(gameRef, {
    guesses: newGuesses,
    errors: newErrors,
    winner
  });
}

// ===== Écouter Firestore =====
onSnapshot(gameRef, snap => {
  if (!snap.exists()) return;
  const data = snap.data();
  currentWord = data.word;
  guessed = data.guesses;
  errors = data.errors;

  updateWordDisplay(currentWord, guessed);
  createLetterButtons();
  errorsDiv.textContent = `Erreurs : ${errors} / ${maxErrors}`;

  if (data.winner) {
    infoDiv.textContent = `Partie terminée ! Gagnant : ${data.winner}`;
    lettersDiv.querySelectorAll("button").forEach(b => b.disabled = true);
  } else {
    infoDiv.textContent = `Joueur : ${pseudo} - Devinez le mot !`;
  }
});
</script>
</body>
</html>
