<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat PWA</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e1f22">

<style>
/* ===== RESET ===== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* ===== GLOBAL ===== */
body {
  font-family: Arial, sans-serif;
  background: #1e1f22;
  color: #fff;
  height: 100vh;
  display: flex;
}

/* ===== APP ===== */
#app {
  display: flex;
  width: 100%;
  height: 100%;
}

/* ===== ROOMS ===== */
#rooms {
  width: 80px;
  background: #111214;
  display: flex;
  flex-direction: column;
  padding: 8px;
  gap: 8px;
}

.room {
  background: #2b2d31;
  color: white;
  padding: 10px;
  border-radius: 50%;
  text-align: center;
  font-size: 12px;
  cursor: pointer;
}

.room.active {
  background: #5865f2;
}

/* ===== CHAT ===== */
#chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* ===== HEADER ===== */
#header {
  height: 50px;
  background: #2b2d31;
  display: flex;
  align-items: center;
  padding: 0 10px;
  font-weight: bold;
}

/* ===== MESSAGES ===== */
#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.message {
  margin-bottom: 10px;
}

.user {
  font-weight: bold;
  color: #00aaff;
}

.text {
  margin-left: 5px;
}

/* ===== INPUT BAR ===== */
#inputBar {
  display: flex;
  padding: 8px;
  background: #2b2d31;
}

#input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: none;
  outline: none;
  background: #1e1f22;
  color: white;
}

#send {
  margin-left: 8px;
  background: #5865f2;
  border: none;
  color: white;
  padding: 10px 15px;
  border-radius: 50%;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="app">

  <!-- SALONS -->
  <div id="rooms">
    <div class="room active" data-room="general">#gen</div>
    <div class="room" data-room="dev">#dev</div>
    <div class="room" data-room="gaming">#game</div>
  </div>

  <!-- CHAT -->
  <div id="chat">
    <div id="header">#general</div>
    <div id="messages"></div>

    <div id="inputBar">
      <input id="input" placeholder="Message..." />
      <button id="send">âž¤</button>
    </div>
  </div>

</div>

<script type="module">
/* ===== FIREBASE ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDL2DDkIFq3HQW8fQLYlGWlVD_KiFb_6iA",
  authDomain: "chat1-591c8.firebaseapp.com",
  projectId: "chat1-591c8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
signInAnonymously(auth);

/* ===== USER ===== */
let pseudo = localStorage.getItem("pseudo");
if (!pseudo) {
  pseudo = prompt("Ton pseudo ?");
  localStorage.setItem("pseudo", pseudo);
}

/* ===== ROOMS ===== */
let currentRoom = "general";
const messagesRef = collection(db, "messages");
let unsubscribe = null;

function loadMessages() {
  if (unsubscribe) unsubscribe();

  const q = query(
    messagesRef,
    where("room", "==", currentRoom),
    orderBy("createdAt")
  );

  unsubscribe = onSnapshot(q, snap => {
    const messages = document.getElementById("messages");
    messages.innerHTML = "";
    snap.forEach(doc => {
      const m = doc.data();
      messages.innerHTML += `
        <div class="message">
          <span class="user">${m.user}</span>
          <span class="text">${m.text}</span>
        </div>
      `;
    });
    messages.scrollTop = messages.scrollHeight;
  });
}

loadMessages();

/* ===== CHANGE ROOM ===== */
document.querySelectorAll(".room").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".room").forEach(r => r.classList.remove("active"));
    btn.classList.add("active");
    currentRoom = btn.dataset.room;
    document.getElementById("header").innerText = "#" + currentRoom;
    loadMessages();
  };
});

/* ===== SEND MESSAGE ===== */
document.getElementById("send").onclick = async () => {
  const input = document.getElementById("input");
  if (!input.value.trim()) return;

  await addDoc(messagesRef, {
    text: input.value,
    user: pseudo,
    room: currentRoom,
    createdAt: serverTimestamp()
  });

  input.value = "";
};

document.getElementById("input").addEventListener("keydown", e => {
  if (e.key === "Enter") document.getElementById("send").click();
});
</script>

</body>
</html>
